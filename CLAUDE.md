# PLY Viewer - 開発ルール

このファイルには、PLY Viewerプロジェクトの開発における重要なルールとガイドラインが記載されています。

## プロジェクト概要

WebベースのPLYファイル3Dビューワー。直感的な箱型マニピュレーターを使用してXYZ軸でのトリミング機能を提供。

### 主要機能
- PLYファイル読み込み（ASCII/Binary対応）
- 3Dモデル表示（ポイントクラウド・サーフェス切り替え）
- 箱型トリミングマニピュレーター
- リアルタイムプレビュー

## 開発ルール

### 1. コミットルール
**重要**: 毎回の出力・変更後に必ずコミットを実行すること

```bash
# 変更をステージングに追加
git add .

# コミットメッセージのフォーマット
git commit -m "機能追加: [追加した機能の説明]

🤖 Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>"
```

### 2. コード品質ルール
- **既存のコード規約に従う**: 既存ファイルのスタイルを維持
- **Three.js r160を使用**: バージョンを変更しない
- **ES6+モジュール構文**: import/export文を使用
- **適切なコメント**: 複雑な処理には日本語コメントを追加

### 3. 機能実装ルール
- **段階的実装**: 大きな機能は小さな単位に分割
- **後方互換性**: 既存機能を破壊しない
- **エラーハンドリング**: 適切な例外処理を実装
- **パフォーマンス**: 大容量PLYファイルでも動作するよう最適化

### 4. UI/UX ルール
- **直感的操作**: 右クリックよりもシンプルな操作を優先
- **視覚的フィードバック**: 操作中は色変更などで状態を明確に
- **レスポンシブ**: モバイルデバイスでも動作

### 5. ファイル構成ルール
- **app.js**: メインアプリケーションロジック
- **index.html**: UIとスタイル定義
- **README.md**: ユーザー向けドキュメント
- **CLAUDE.md**: 開発ルール（このファイル）

## 操作仕様詳細

### 1. 面拡大縮小操作
**目的**: 箱の特定面を移動してトリミング範囲を調整

**操作手順**:
1. **面選択**: 箱の任意の面をクリック
   - クリックした面に矢印ハンドルが表示
   - 矢印は面の法線方向を向く
2. **面移動**: 矢印ハンドルをドラッグ
   - ドラッグ方向に面が移動
   - 対面は固定点として動かない
   - 最小サイズ（0.1）以下にはならない
3. **選択解除**: 空白部分をクリック
   - 矢印ハンドルが非表示になる

**技術仕様**:
- 移動感度: 0.12倍
- カメラ相対座標での移動計算
- 画面座標→3D世界座標の変換使用

### 2. 自由変形（頂点操作）
**目的**: 箱の形状を自由に変形してトリミング範囲を細かく調整

**操作手順**:
1. **頂点選択**: 箱の8つの角（頂点）のいずれかをクリック
   - 選択した頂点が黄色にハイライト
   - 他の7つの頂点は固定
2. **頂点移動**: 選択した頂点をドラッグ
   - 3D空間で自由に移動可能
   - リアルタイムで箱の形状が変化
3. **変形完了**: マウスリリースで確定

**技術仕様**:
- 8頂点の座標管理
- 動的なジオメトリ更新
- 隣接面の連動変形

### 3. ホバー効果
**視覚的フィードバック**:
- **面**: ホバー時に薄い黄色（0xffff80）で表示
- **頂点**: ホバー時に薄い黄色（0xffff80）で表示
- **選択中**: 濃い黄色（0xffff00）で表示

### 4. ドラッグ操作の共通仕様

**座標変換**:
- スクリーン座標（マウス）→ 3D世界座標
- カメラの視点・距離・FOVを考慮
- カメラの右方向・上方向ベクトル使用

**感度調整**:
- 面操作: 0.12倍（精密操作）
- 頂点操作: 標準感度

**制約**:
- 最小サイズ制限（0.1）
- オーバーフロー防止
- リアルタイム更新

**操作中の視覚効果**:
- カーソル変更（grabbing）
- カメラコントロール無効化
- トリミング情報表示

## 最近の主要変更

### ホバー効果の改善
- 面・頂点のホバー時色変更を薄い黄色に統一
- 選択時と区別しやすい視覚フィードバック

### 操作フロー
1. 面をクリック → 矢印ハンドル表示
2. 矢印ドラッグ → 面拡縮
3. 頂点クリック → 自由変形
4. 空白クリック → 選択解除

## 注意事項

- **セキュリティ**: 悪意のあるコードの作成・改良は禁止
- **メモリ管理**: 大容量ファイル処理時のメモリリーク防止
- **ブラウザ互換性**: Chrome 90+, Firefox 88+, Safari 14+, Edge 90+

## 次回開発時の参考

このプロジェクトを再開する際は：
1. このCLAUDE.mdを最初に確認
2. README.mdで現在の機能を把握
3. app.jsの主要クラス構造を理解
4. 変更後は必ずコミット実行